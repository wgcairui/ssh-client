name: Build Android APK

# This workflow builds Android APK files for the SSH client application
# Features:
# - âœ… Multi-level caching for faster builds
# - âœ… Pub dependencies cache
# - âœ… Gradle wrapper and dependencies cache  
# - âœ… Android build cache
# - âœ… Code obfuscation for release builds
# - âœ… Split APKs by architecture for smaller downloads
# - âœ… Debug symbols for crash analysis

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

# å–æ¶ˆæ—§çš„è¿è¡Œä¸­çš„å·¥ä½œæµ
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# æƒé™è®¾ç½®
permissions:
  contents: write  # åˆ›å»ºreleaseséœ€è¦å†™å…¥æƒé™
  actions: read
  checks: read

# Global environment variables for consistency
env:
  FLUTTER_VERSION: '3.27.1'
  JAVA_VERSION: '17'
  GRADLE_OPTS: -Dorg.gradle.daemon=false
  GRADLE_USER_HOME: ${{ github.workspace }}/.gradle

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Java ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{ env.JAVA_VERSION }}
        
    - name: Setup Flutter ${{ env.FLUTTER_VERSION }}
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true
        
    # Cache Pub dependencies
    - name: Cache Pub dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.pub-cache
          **/.dart_tool
          **/.packages
        key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
        restore-keys: |
          ${{ runner.os }}-pub-
          
    # Cache Gradle dependencies
    - name: Cache Gradle Wrapper
      uses: actions/cache@v4
      with:
        path: ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-wrapper-${{ hashFiles('**/gradle/wrapper/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-wrapper-

    - name: Cache Gradle Dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/buildOutputCleanup
        key: ${{ runner.os }}-gradle-caches-${{ hashFiles('**/*.gradle', '**/gradle.properties', '**/gradle/wrapper/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-caches-
          
    # Cache Android build outputs
    - name: Cache Android Build
      uses: actions/cache@v4
      with:
        path: |
          android/app/build
          android/build
          android/.gradle
        key: ${{ runner.os }}-android-build-${{ hashFiles('android/**/*.gradle', 'android/**/gradle.properties', 'pubspec.lock') }}
        restore-keys: |
          ${{ runner.os }}-android-build-
        
    - name: Get dependencies
      run: flutter pub get
      
    - name: Analyze code
      run: flutter analyze
      
    - name: Run tests
      run: flutter test
      
    - name: Build APK (Debug)
      run: |
        flutter build apk --debug \
          --dart-define=FLUTTER_WEB_AUTO_DETECT=true \
          --no-tree-shake-icons
      
    - name: Build APK (Release - Universal)
      run: |
        flutter build apk --release \
          --dart-define=FLUTTER_WEB_AUTO_DETECT=true \
          --obfuscate \
          --split-debug-info=build/app/outputs/symbols
          
    - name: Build APK (Release - Split by ABI)
      run: |
        flutter build apk --release \
          --dart-define=FLUTTER_WEB_AUTO_DETECT=true \
          --split-per-abi \
          --obfuscate \
          --split-debug-info=build/app/outputs/symbols-split
      
    - name: Upload Debug APK
      uses: actions/upload-artifact@v4
      with:
        name: ssh-client-debug-apk
        path: build/app/outputs/flutter-apk/app-debug.apk
        retention-days: 30
        
    - name: Upload Release APK (Universal)
      uses: actions/upload-artifact@v4
      with:
        name: ssh-client-release-apk-universal
        path: build/app/outputs/flutter-apk/app-release.apk
        retention-days: 90
        
    - name: Upload Release APKs (Split)
      uses: actions/upload-artifact@v4
      with:
        name: ssh-client-release-apks-split
        path: build/app/outputs/flutter-apk/app-*-release.apk
        retention-days: 90
        
    - name: Upload Debug Symbols
      uses: actions/upload-artifact@v4
      with:
        name: ssh-client-debug-symbols
        path: |
          build/app/outputs/symbols/
          build/app/outputs/symbols-split/
        retention-days: 90

  # Create development release for main branch pushes
  dev-release:
    if: github.ref == 'refs/heads/main' && github.event_name == 'push' && contains(github.event.head_commit.message, 'feat:')
    needs: build
    runs-on: ubuntu-latest
    
    steps:
    - name: Download Release APK
      uses: actions/download-artifact@v4
      with:
        name: ssh-client-release-apk-universal
        path: ./release-apk
        
    - name: Download Split APKs
      uses: actions/download-artifact@v4
      with:
        name: ssh-client-release-apks-split
        path: ./split-apks
        
    - name: Get current date
      id: date
      run: echo "date=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT
      
    - name: Get short commit SHA
      id: sha
      run: echo "sha=$(echo $GITHUB_SHA | cut -c1-8)" >> $GITHUB_OUTPUT
      
    - name: Create Development Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: dev-${{ steps.date.outputs.date }}-${{ steps.sha.outputs.sha }}
        name: SSHå®¢æˆ·ç«¯å¼€å‘ç‰ˆ ${{ steps.date.outputs.date }}
        body: |
          ## ğŸš€ SSHå®¢æˆ·ç«¯å¼€å‘ç‰ˆ
          
          **æ„å»ºæ—¶é—´**: ${{ steps.date.outputs.date }}
          **æäº¤**: ${{ steps.sha.outputs.sha }}
          **åˆ†æ”¯**: main
          
          ### ğŸ“± ä¸‹è½½è¯´æ˜
          - **app-release.apk**: é€šç”¨ç‰ˆæœ¬ï¼Œæ”¯æŒæ‰€æœ‰æ¶æ„
          - **app-arm64-v8a-release.apk**: ARM64æ¶æ„ä¼˜åŒ–ç‰ˆæœ¬ï¼ˆæ¨èç°ä»£è®¾å¤‡ï¼‰
          - **app-armeabi-v7a-release.apk**: ARM32æ¶æ„ç‰ˆæœ¬ï¼ˆå…¼å®¹è€è®¾å¤‡ï¼‰
          - **app-x86_64-release.apk**: x86_64æ¶æ„ç‰ˆæœ¬ï¼ˆæ¨¡æ‹Ÿå™¨å’Œx86è®¾å¤‡ï¼‰
          
          ### âœ¨ æ–°åŠŸèƒ½
          - å¤šæ ‡ç­¾é¡µæ”¯æŒï¼šåŒæ—¶ç®¡ç†æœ€å¤š10ä¸ªSSHè¿æ¥
          - æ™ºèƒ½ç„¦ç‚¹ç®¡ç†ï¼šä¼˜åŒ–çš„é”®ç›˜è¾“å…¥å¤„ç†
          - ä¼šè¯ä¿æŒæœºåˆ¶ï¼šSSHè¿æ¥åœ¨åå°ä¿æŒæ´»è·ƒ
          
          ### ğŸ”§ ç³»ç»Ÿè¦æ±‚
          - Android 5.0 (API 21) æˆ–æ›´é«˜ç‰ˆæœ¬
          - æ¨èåœ¨å¹³æ¿è®¾å¤‡ä¸Šä½¿ç”¨ä»¥è·å¾—æœ€ä½³ä½“éªŒ
          
          ---
          
          > âš ï¸ è¿™æ˜¯å¼€å‘ç‰ˆæœ¬ï¼Œä»…ç”¨äºæµ‹è¯•ã€‚æ­£å¼ç‰ˆæœ¬è¯·æŸ¥çœ‹å¸¦æœ‰ç‰ˆæœ¬å·çš„Releaseã€‚
        files: |
          ./release-apk/app-release.apk
          ./split-apks/app-*-release.apk
        draft: false
        prerelease: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Create official release when pushing version tags
  official-release:
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Java ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{ env.JAVA_VERSION }}
        
    - name: Setup Flutter ${{ env.FLUTTER_VERSION }}
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true
        
    # Cache Pub dependencies
    - name: Cache Pub dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.pub-cache
          **/.dart_tool
          **/.packages
        key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
        restore-keys: |
          ${{ runner.os }}-pub-
          
    # Cache Gradle dependencies
    - name: Cache Gradle Wrapper
      uses: actions/cache@v4
      with:
        path: ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-wrapper-${{ hashFiles('**/gradle/wrapper/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-wrapper-

    - name: Cache Gradle Dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/buildOutputCleanup
        key: ${{ runner.os }}-gradle-caches-${{ hashFiles('**/*.gradle', '**/gradle.properties', '**/gradle/wrapper/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-caches-
          
    # Cache Android build outputs
    - name: Cache Android Build
      uses: actions/cache@v4
      with:
        path: |
          android/app/build
          android/build
          android/.gradle
        key: ${{ runner.os }}-android-build-${{ hashFiles('android/**/*.gradle', 'android/**/gradle.properties', 'pubspec.lock') }}
        restore-keys: |
          ${{ runner.os }}-android-build-
        
    - name: Get dependencies
      run: flutter pub get
      
    - name: Analyze code
      run: flutter analyze
      
    - name: Run tests
      run: flutter test
      
    - name: Build APK (Release - Universal)
      run: |
        flutter build apk --release \
          --dart-define=FLUTTER_WEB_AUTO_DETECT=true \
          --obfuscate \
          --split-debug-info=build/app/outputs/symbols
          
    - name: Build APK (Release - Split by ABI)
      run: |
        flutter build apk --release \
          --dart-define=FLUTTER_WEB_AUTO_DETECT=true \
          --split-per-abi \
          --obfuscate \
          --split-debug-info=build/app/outputs/symbols-split
      
    - name: Get tag name
      id: tag
      run: echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
    - name: Create Official Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.tag.outputs.tag }}
        name: SSHå®¢æˆ·ç«¯ ${{ steps.tag.outputs.tag }}
        body: |
          ## ğŸ‰ SSHå®¢æˆ·ç«¯æ­£å¼ç‰ˆ ${{ steps.tag.outputs.tag }}
          
          ### âœ¨ æ ¸å¿ƒåŠŸèƒ½
          - ğŸ” **å¤šé‡è®¤è¯**: æ”¯æŒå¯†ç å’ŒSSHå¯†é’¥è®¤è¯
          - ğŸ“ **æ–‡ä»¶ä¼ è¾“**: å®Œæ•´çš„SFTPæ–‡ä»¶ä¼ è¾“åŠŸèƒ½
          - ğŸ“± **å¹³æ¿ä¼˜åŒ–**: ä¸“ä¸ºå¹³æ¿è®¾å¤‡è®¾è®¡çš„åˆ†å±ç•Œé¢
          - ğŸ·ï¸ **å¤šæ ‡ç­¾é¡µ**: åŒæ—¶ç®¡ç†æœ€å¤š10ä¸ªSSHè¿æ¥
          - ğŸ¯ **æ™ºèƒ½ç„¦ç‚¹**: ä¼˜åŒ–çš„é”®ç›˜è¾“å…¥å¤„ç†
          - âš¡ **ä¼šè¯ä¿æŒ**: SSHè¿æ¥åœ¨åå°ä¿æŒæ´»è·ƒ
          - ğŸŒ— **ä¸»é¢˜æ”¯æŒ**: æ˜æš—ä¸»é¢˜è‡ªåŠ¨åˆ‡æ¢
          - ğŸ“‹ **å†å²è®°å½•**: è¿æ¥å†å²å’Œå¿«é€Ÿé‡è¿
          
          ### ğŸ“± ä¸‹è½½é€‰æ‹©
          - **app-release.apk**: é€šç”¨ç‰ˆæœ¬ï¼Œæ”¯æŒæ‰€æœ‰è®¾å¤‡ **(æ¨è)**
          - **app-arm64-v8a-release.apk**: ARM64ä¼˜åŒ–ç‰ˆæœ¬ï¼ˆç°ä»£Androidè®¾å¤‡ï¼‰
          - **app-armeabi-v7a-release.apk**: ARM32ç‰ˆæœ¬ï¼ˆå…¼å®¹è€è®¾å¤‡ï¼‰
          - **app-x86_64-release.apk**: x86_64ç‰ˆæœ¬ï¼ˆæ¨¡æ‹Ÿå™¨å’Œç‰¹æ®Šè®¾å¤‡ï¼‰
          
          ### ğŸ”§ ç³»ç»Ÿè¦æ±‚
          - **æœ€ä½ç‰ˆæœ¬**: Android 5.0 (API 21)
          - **æ¨èé…ç½®**: Android 8.0+ çš„å¹³æ¿è®¾å¤‡
          - **å±å¹•å°ºå¯¸**: 7è‹±å¯¸ä»¥ä¸Šå¹³æ¿è·å¾—æœ€ä½³ä½“éªŒ
          
          ### ğŸ†• æœ¬ç‰ˆæœ¬æ›´æ–°
          æŸ¥çœ‹ [CHANGELOG.md](https://github.com/cairui/ssh-client/blob/main/CHANGELOG.md) äº†è§£è¯¦ç»†æ›´æ–°å†…å®¹ã€‚
          
          ### ğŸ› é—®é¢˜æŠ¥å‘Š
          å¦‚é‡é—®é¢˜è¯·è®¿é—® [Issuesé¡µé¢](https://github.com/cairui/ssh-client/issues) åé¦ˆã€‚
          
        files: |
          build/app/outputs/flutter-apk/app-release.apk
          build/app/outputs/flutter-apk/app-*-release.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}